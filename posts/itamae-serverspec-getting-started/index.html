<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=HandheldFriendly content="True"><meta http-equiv=x-ua-compatible content="IE=edge"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=generator content="Hugo 0.68.3"><link rel="shortcut icon" href=https://cdn.jsdelivr.net/gh/amzrk2/poal-jsdelivr@1.2.0/favicons/favicon.ico><title>Itamae & Serverspec ことはじめ - mknkisk.log</title><meta name=author content><meta name=description content="Itamae を使って Vagrant 環境を構築してみます。 また、構築した環境は Serverspec でテストします。
今回のサンプルコードは GitHub にアップしました。
Env  Mac OS X El Capitan 10.11.4 ruby 2.3.1 rake 11.1.2 itamae 1.9.6 serverspec 2.34.0 Vagrant 1.8.1  Vagrant セットアップ まずは Vagrant の設定を。
$ mkdir workdir; cd workdir $ vagrant init CentOS7 で試してみたことがあったので、今回は Ubuntu でいきます。
$ vagrant init ubuntu/trusty64; vagrant up --provider virtualbox ref: https://git.io/vrsCY
起動した Vagrant にログインできることを確認。
$ vagrant ssh Itamae で Nginx をインストール Itamae も Serverspec も Ruby の Gem で公開されています。 Bundler を使ってインストールします。"><meta property="og:title" content="Itamae & Serverspec ことはじめ"><meta property="og:description" content="Itamae を使って Vagrant 環境を構築してみます。 また、構築した環境は Serverspec でテストします。
今回のサンプルコードは GitHub にアップしました。
Env  Mac OS X El Capitan 10.11.4 ruby 2.3.1 rake 11.1.2 itamae 1.9.6 serverspec 2.34.0 Vagrant 1.8.1  Vagrant セットアップ まずは Vagrant の設定を。
$ mkdir workdir; cd workdir $ vagrant init CentOS7 で試してみたことがあったので、今回は Ubuntu でいきます。
$ vagrant init ubuntu/trusty64; vagrant up --provider virtualbox ref: https://git.io/vrsCY
起動した Vagrant にログインできることを確認。
$ vagrant ssh Itamae で Nginx をインストール Itamae も Serverspec も Ruby の Gem で公開されています。 Bundler を使ってインストールします。"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.mknkisk.com/posts/itamae-serverspec-getting-started/"><meta property="article:published_time" content="2016-05-15T15:20:36+09:00"><meta property="article:modified_time" content="2016-05-15T15:20:36+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Itamae & Serverspec ことはじめ"><meta name=twitter:description content="Itamae を使って Vagrant 環境を構築してみます。 また、構築した環境は Serverspec でテストします。
今回のサンプルコードは GitHub にアップしました。
Env  Mac OS X El Capitan 10.11.4 ruby 2.3.1 rake 11.1.2 itamae 1.9.6 serverspec 2.34.0 Vagrant 1.8.1  Vagrant セットアップ まずは Vagrant の設定を。
$ mkdir workdir; cd workdir $ vagrant init CentOS7 で試してみたことがあったので、今回は Ubuntu でいきます。
$ vagrant init ubuntu/trusty64; vagrant up --provider virtualbox ref: https://git.io/vrsCY
起動した Vagrant にログインできることを確認。
$ vagrant ssh Itamae で Nginx をインストール Itamae も Serverspec も Ruby の Gem で公開されています。 Bundler を使ってインストールします。"><link rel=stylesheet href=https://blog.mknkisk.com/css/main.min.css><script src=https://blog.mknkisk.com/js/jquery.min.js></script><script src=https://blog.mknkisk.com/js/lazysizes.min.js></script><link rel=stylesheet href=https://blog.mknkisk.com/css/fontawsome.min.css><script src=https://blog.mknkisk.com/js/medium-zoom.min.js></script><body class="d-flex flex-column h-100"><header><div class="container-lg clearfix"><div class="col-12 link-primary"><a class=main-title href=https://blog.mknkisk.com/>mknkisk.log</a></div></div></header><main><div class="container-lg clearfix"><div class="col-md-9 col-12 float-left" id=content><article><h4 class=post-title><a href=https://blog.mknkisk.com/posts/itamae-serverspec-getting-started/>Itamae & Serverspec ことはじめ</a></h4><div class="post-meta link-alter"><time><i class="fas fa-calendar-day"></i>&nbsp;2016-05-15</time><span><i class="fas fa-tag"></i>&nbsp;No tag</span></div><div class="post-content markdown-body"><p><a href=https://github.com/itamae-kitchen/itamae target=_blank>Itamae</a> を使って Vagrant 環境を構築してみます。
また、構築した環境は <a href=http://serverspec.org/ target=_blank>Serverspec</a> でテストします。</p><p>今回のサンプルコードは <a href=https://github.com/mknkisk/itamae-samples target=_blank>GitHub</a> にアップしました。</p><h2 id=env>Env</h2><ul><li>Mac OS X El Capitan 10.11.4</li><li>ruby 2.3.1</li><li>rake 11.1.2</li><li>itamae 1.9.6</li><li>serverspec 2.34.0</li><li>Vagrant 1.8.1</li></ul><h2 id=vagrant-セットアップ>Vagrant セットアップ</h2><p>まずは Vagrant の設定を。</p><pre><code>$ mkdir workdir; cd workdir
$ vagrant init
</code></pre><p>CentOS7 で試してみたことがあったので、今回は Ubuntu でいきます。</p><pre><code>$ vagrant init ubuntu/trusty64; vagrant up --provider virtualbox
</code></pre><p>ref: <a href=https://git.io/vrsCY>https://git.io/vrsCY</a></p><p>起動した Vagrant にログインできることを確認。</p><pre><code>$ vagrant ssh
</code></pre><h2 id=itamae-で-nginx-をインストール>Itamae で Nginx をインストール</h2><p>Itamae も Serverspec も Ruby の Gem で公開されています。
Bundler を使ってインストールします。</p><pre><code>$ bundle init
$ vim Gemfile
$ # diff

+ gem 'itamae'
+ gem 'serverspec'

$ bundle install --path vendor/bundle --jobs 4
</code></pre><p>ref: <a href=https://git.io/vrsB4>https://git.io/vrsB4</a></p><p>Itamae には決まったディレクトリ構成はありませんが、推奨の構成があります。<a href=https://github.com/itamae-kitchen/itamae/wiki/Best-Practice#directory-structure target=_blank>Best Practice · itamae-kitchen/itamae
Wiki</a></p><p>今回はこの構成で進めていきます。
</p><pre><code>$ bundle exec itamae init
$ tree
.
├── Gemfile
├── Gemfile.lock
├── Vagrantfile
├── cookbooks
└── roles
</code></pre><p>手始めに Nginx のインストールレシピを書いてみます。</p><pre><code>$ vim cookbooks/nginx/default.rb
$ vim roles/web.rb
</code></pre><p>ref: <a href=https://git.io/vrsB4>https://git.io/vrsB4</a></p><p>このレシピを Vagrant に反映します。
</p><pre><code>$ # .ssh/config に Vagrant のホスト設定を追加
$ vagrant ssh-config --host localhost.ubuntu &gt;&gt; ~/.ssh/config
$
$ # Itamae を実行
$ itamae ssh --vagrant --host localhost.ubuntu roles/web.rb
 INFO : Starting Itamae...
 INFO : Recipe: /your/workdir/roles/web.rb
 INFO :   Recipe: /your/workdir/cookbooks/nginx/default.rb
</code></pre><p>Vagrant 上で起動を確認</p><pre><code>$ vagrant ssh
vagrant@localhost:~$ service status nginx
status: unrecognized service
</code></pre><h2 id=serverspec-で-nginx-周りをテスト>Serverspec で Nginx 周りをテスト</h2><p>さて、せっかくサーバのセットアップがコード化できたので、設定の確認作業もコードで管理したいところです。</p><p>Serverspec でテストコードを書いていきます。
Serverspec も Itamae 同様にディレクトリをどう構成するするかは自由ですがコマンドでテンプレートを作ることができます。
こちらもデフォルトの構成で進めます。</p><p>serverspec-init コマンドを使って対話式でテンプレートを作成します。</p><pre><code>$ bundle exec serverspec-init
Select OS type:

  1) UN*X
  2) Windows

Select number: 1

Select a backend type:

  1) SSH
  2) Exec (local)

Select number: 1

Vagrant instance y/n: y
Auto-configure Vagrant from Vagrantfile? y/n: n
Input vagrant instance name: localhost.ubuntu
 + spec/
 + spec/localhost.ubuntu/
 + spec/localhost.ubuntu/sample_spec.rb
 + spec/spec_helper.rb
 + Rakefile
 + .rspec
</code></pre><p>ref: <a href=https://git.io/vrs7b>https://git.io/vrs7b</a></p><p>spec 配下に作成されたディレクトリはテスト対象のホスト名です。
テストコードを対象ホスト単位でまとめるのか、ロール(web や db など)でまとめるのかは自由です。
Rakefile のコードを修正することで自由に編成できます。</p><p>Serverspecのサイトにあるサンプルが参考になります。
ref: <a href=http://serverspec.org/advanced_tips.html target=_blank>Serverspec - Advanced Tips</a></p><p>Nginx のインストールとサービス設定、そして 80 ポートを Listen してるかのテストをします。</p><p>ref: <a href=https://git.io/vrs7A>https://git.io/vrs7A</a></p><p>テストは Rake で実行します。Rake タスクは動的に定義されます。(Rakefile 参照)
定義された Rake タスクは rake -T で確認できます。</p><pre><code>$ rake -T
rake spec:localhost.ubuntu  # Run serverspec tests to localhost.ubuntu
</code></pre><p>テストを実行します。</p><pre><code>$ rake spec:localhost.ubuntu
/Users/keisuke/.rbenv/versions/2.3.1/bin/ruby -I/Users/keisuke/.rbenv/versions/2.3.1/lib/ruby/gems/2.3.0/gems/rspec-support-3.4.1/lib:/Users/keisuke/.rbenv/versions/2.3.1/lib/ruby/gems/2.3.0/gems/rspec-core-3.4.4/lib /Users/keisuke/.rbenv/versions/2.3.1/lib/ruby/gems/2.3.0/gems/rspec-core-3.4.4/exe/rspec --pattern spec/localhost.ubuntu/\*_spec.rb

Package &quot;nginx&quot;
  should be installed

Service &quot;nginx&quot;
  should be enabled
  should be running

Port &quot;80&quot;
  should be listening

Finished in 0.58268 seconds (files took 5.66 seconds to load)
4 examples, 0 failures
</code></pre><p>テスト成功です :)</p><p>実際にはテストコードを共通化したり、複数ホストにテストを同時実行したりと、もっとカスタマイズすることになるでしょう。
その辺も実装してみたので、また今度まとめたいですね。</p><h2 id=おわり>おわり</h2><p>たまにしかやらないからこそ、コード化できていると良いですね。仕事でも導入しましたが、インフラの変更履歴も共有でき、何よりテストが自動化できたのには安心感が増します。</p><p>とりあえず、初めの1歩でした :P</p></div></article><div class="license markdown-body"><blockquote><p>Unless otherwise noted, the content of this site is licensed under <a rel=license href target=_blank></a>.</p></blockquote></div></div><div class="col-md-3 col-12 float-left link-alter" id=sidebar><div class=widget-toc><h5>TOC</h5><nav id=TableOfContents><ul><li><a href=#env>Env</a></li><li><a href=#vagrant-セットアップ>Vagrant セットアップ</a></li><li><a href=#itamae-で-nginx-をインストール>Itamae で Nginx をインストール</a></li><li><a href=#serverspec-で-nginx-周りをテスト>Serverspec で Nginx 周りをテスト</a></li><li><a href=#おわり>おわり</a></li></ul></nav></div><div class=widget-pages><h5>Pages</h5><ul><li><a href=/index.xml target=_blank>RSS</a></li></ul></div><div class=widget-tags><h5>Tags</h5><div></div></div><div class=widget-links><h5>Links</h5><ul></ul></div></div></div></main><footer><div class="container-lg text-center"><p>&copy; 2020 <a href=https://blog.mknkisk.com/></a>| Powered by <a href=https://github.com/amzrk2/hugo-theme-fuji/ target=_blank>Fuji</a> & <a href=https://gohugo.io/ target=_blank>Hugo</a></p></div></footer><script>$(function(){mediumZoom('.img-zoomable',{margin:32});});</script><script>$('.widget-toc a').click(function(){$('html, body').animate({scrollTop:$($(this).attr('href')).offset().top});});</script></body></html>